<!doctype html>
<html lang="fr" class="r-VerticalRhythm"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimal-ui"><title>npm: choisir la bonne version de ses dÃ©pendances</title><link rel="stylesheet" href="/index.css"><link rel="alternate" href="/feed.xml" title="npm: choisir la bonne version de ses dÃ©pendances" type="application/atom+xml"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@putaindecode"><meta name="twitter:title" content="npm: choisir la bonne version de ses dÃ©pendances"><meta name="twitter:creator" content="@_kud"><meta property="og:title" content="npm: choisir la bonne version de ses dÃ©pendances"><meta property="og:type" content="article"><meta property="og:site_name" content="Putain de code !"></head><body><div class="putainde-Header"><div class="r-Grid"><div class="r-Grid-cell r-all--5of12"><a class="putainde-SiteTitle" href="/"><img class="putainde-Logo" alt="Putain de code !" src="/images/p!-logo.svg"><span>Putain de code !</span></a></div><div class="r-Grid-cell r-all--7of12"><nav class="putainde-Nav"><a class="putainde-Nav-item" href="/posts" data-r-tooltip=""><img class="putainde-Icon" src="/icons/bookmark.svg">Articles</a><a class="putainde-Nav-item" href="/c-est-quoi-putaindecode" data-r-tooltip=""><img class="putainde-Icon" src="/icons/text-file.svg">Readme</a><a class="putainde-Nav-item" href="/posts/comment-contribuer" data-r-tooltip=""><img class="putainde-Icon" src="/icons/pencil.svg">Participer</a><a class="putainde-Nav-item putainde-Nav-item--icon r-Tooltip r-Tooltip--bottom" href="https://github.com/putaindecode/" data-r-tooltip="GitHub"><img class="putainde-Icon" src="/icons/github.svg"></a><a class="putainde-Nav-item putainde-Nav-item--icon r-Tooltip r-Tooltip--bottom" href="https://twitter.com/putaindecode/" data-r-tooltip="Twitter"><img class="putainde-Icon" src="/icons/twitter.svg"></a></nav></div></div></div><div class="putainde-Main"><article class="r-Grid putainde-Post"><div class="r-Grid-cell r-all--8of12 putainde-Post-contents"><div class="putainde-Title"><h1 class="putainde-Title-text">npm: choisir la bonne version de ses dÃ©pendances</h1></div><header class="putainde-Post-header"><div class="putainde-Post-metas"><span>Ã‰crit par <span><a href="http://kud.io">kud</a><span></span></span></span><span>, </span><span class="putainde-Date"> le 12 mai 2014</span>. <span class="putainde-Post-readingTime putainde-Post-readingTime--hidden r-Tooltip r-Tooltip--top" data-r-tooltip="Temps de lecture approximatif, sur une base de {{wpm}} mots par minute" data-readingtime-wpm="250">Temps de lecture : environ  <span class="putainde-Post-readingTime-value">...</span> minutes</span></div><ul class="putainde-Tags putainde-Post-tags"><li class="putainde-Tag">npm</li><li class="putainde-Tag">javascript</li><li class="putainde-Tag">nodejs</li></ul></header><div class="putainde-Post-md"><div><p>Pas plus tard quâ€™hier, alors que je travaillais tranquillement, apparu soudainement un bug dans mon <em>workflow</em> de <em>build</em>. Il ne mâ€™Ã©tait plus possible avec <a href="https://github.com/gruntjs/grunt-contrib-clean">grunt-contrib-clean</a> de supprimer des fichiers. Hmmm, ballot, car sans la suppression, mon <em>workflow</em> devenait tout bancal. Bien. Il me fallut remonter la riviÃ¨re - comme souvent, en tant que dÃ©veloppeur - afin de constater oÃ¹ Ã©tait le bug. Je suis alors tombÃ© sur <a href="https://github.com/isaacs/rimraf">rimraf</a> (bon câ€™Ã©tait pas bien loin) qui sâ€™Ã©tait vu Ãªtre mis Ã  jour il y a Ã  peine 12 heures, comprenant un bug.</p>
<h2 id="contexte">
      <a class="putainde-Title-anchor" href="#contexte">#</a>
      Contexte
    </h2><p>Bon, vous voyez le topo ?</p>
<pre><code>{
  "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"grunt-contrib-clean"</span></span>,
  "<span class="hljs-attribute">dependencies</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">rimraf</span>": <span class="hljs-value"><span class="hljs-string">"~2.2.1"</span>
  </span>}
</span>}
</code></pre><p><a href="https://github.com/gruntjs/grunt-contrib-clean">grunt-contrib-clean</a> qui contient en <em>dependencies</em> <a href="https://github.com/isaacs/rimraf">rimraf</a> avec une version bugguÃ©e. Oh la belle affaire. Oui car <code>~2.2.1</code> veut dire â€œ<a href="https://github.com/isaacs/node-semver#ranges">Raisonnablement proche de 2.2.1</a>â€œ, ce qui se traduit par tÃ©lÃ©charger la derniÃ¨re version en <code>2.2.x</code>, soit la <code>2.2.7</code> (celle bugguÃ©e) lorsque je mis Ã  jour le package <a href="https://github.com/gruntjs/grunt-contrib-clean">grunt-contrib-clean</a>.</p>
<h2 id="le-hic">
      <a class="putainde-Title-anchor" href="#le-hic">#</a>
      Le hic
    </h2><p>Une question mâ€™est venue : comment faire en sorte de figer la version de <a href="https://github.com/isaacs/rimraf">rimraf</a> qui est une dÃ©pendance de dÃ©pendance ?</p>
<p>Ha ! Pas Ã©vident comme Ã§a.</p>
<p>Jâ€™ai dâ€™abord essayÃ© sans trop dâ€™espoir de tÃ©lÃ©charger <a href="https://github.com/isaacs/rimraf">rimraf</a> lui-mÃªme en <code>2.2.6</code> mais vu que chaque dÃ©pendance Ã  ses propres dÃ©pendances et quâ€™elles ne se les partagent pasâ€¦ câ€™Ã©tait peine perdue.</p>
<p>Jâ€™ai donc cherchÃ©, cherchÃ©, et je suis tombÃ© sur <a href="https://www.npmjs.org/doc/cli/npm-shrinkwrap.html">npm-shrinkwrap</a>: â€œLock down dependency versionsâ€. Bingo !</p>
<h2 id="npm-shrinkwrap-la-solution-pour-figer-vos-dependances-toutes-vos-dependances">
      <a class="putainde-Title-anchor" href="#npm-shrinkwrap-la-solution-pour-figer-vos-dependances-toutes-vos-dependances">#</a>
      npm-shrinkwrap, la solution pour figer vos depÃ©ndances, toutes vos dÃ©pendances
    </h2><p><a href="https://www.npmjs.org/doc/cli/npm-shrinkwrap.html">npm-shrinkwrap</a> va vous permettre de dÃ©finir avec prÃ©cision chaque version de chaque dÃ©pendance.</p>
<p>Pour cela, faites dâ€™abord un <code>npm install</code> (si vous avez Ã©videmment un <code>package.json</code>) afin dâ€™installer vos <code>node_modules</code>. Une fois cela fait, lancez <code>npm shrinkwrap</code> qui crÃ©era le fichier <code>npm-shrinkwrap.json</code> qui comprendra toutes les dÃ©finitions de chaque dÃ©pendance.</p>
<h3 id="figer-une-dependance-de-dependance">
      <a class="putainde-Title-anchor" href="#figer-une-dependance-de-dependance">#</a>
      Figer une dÃ©pendance de dÃ©pendance
    </h3><p>Simple, regardez :</p>
<pre><code>{
  "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"my-project"</span></span>,
  "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"1.0.0"</span></span>,
  "<span class="hljs-attribute">dependencies</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">grunt-contrib-clean</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"0.5.0"</span></span>,
      "<span class="hljs-attribute">from</span>": <span class="hljs-value"><span class="hljs-string">"grunt-contrib-clean@~0.5.*"</span></span>,
      "<span class="hljs-attribute">dependencies</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">rimraf</span>": <span class="hljs-value">{
          "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"2.2.6"</span></span>,
          "<span class="hljs-attribute">from</span>": <span class="hljs-value"><span class="hljs-string">"rimraf@~2.2.1"</span></span>,
          "<span class="hljs-attribute">resolved</span>": <span class="hljs-value"><span class="hljs-string">"https://registry.npmjs.org/rimraf/-/rimraf-2.2.6.tgz"</span>
        </span>}
      </span>}
    </span>}
  </span>}
</span>}
</code></pre><p>Jâ€™ai dÃ©fini la version de <a href="https://github.com/isaacs/rimraf">rimraf</a> dans <code>dependencies.grunt-contrib-clean.dependencies.rimraf</code>.</p>
<p>Bon, je ne connais pas tout par coeur non plus, npm-shrinkwrap vous Ã©crira la totalitÃ© du fichier avec toutes les dÃ©finitions mais jâ€™ai volontairement tout supprimÃ© et gardÃ© uniquement la partie <a href="https://github.com/gruntjs/grunt-contrib-clean">grunt-contrib-clean</a> car seule cette partie est Ã  figer. Quand je dis supprimer, je parle rÃ©ellement dans le fichier final, pas juste ici dans lâ€™article.</p>
<p>Vous aurez toute lâ€™explication de npm-shrinkwrap sur la <a href="https://www.npmjs.org/doc/cli/npm-shrinkwrap.html">documentation officielle [en]</a>.</p>
<h2 id="choisir-la-bonne-strategie-de-version">
      <a class="putainde-Title-anchor" href="#choisir-la-bonne-strategie-de-version">#</a>
      Choisir la bonne stratÃ©gie de version
    </h2><p>Parce quâ€™il est important de savoir quelle version exacte nous souhaitons installer dans notre projet, il faut dÃ©finir avec prÃ©cisions ces versions dans <code>package.json</code>.</p>
<p>Vous pouvez avoir <code>1.2.1</code> ou encore <code>~1.4.6</code> ou bien encore <code>^2.3.1</code>. Mais que veulent dire <code>^</code> ou <code>~</code> ?</p>
<ul>
<li><code>1.2.1</code> : cette version exacte</li>
<li><code>~1.4.6</code> : raisonnablement proche de <code>1.4.6</code></li>
<li><code>^2.3.1</code> : compatible avec <code>2.3.1</code></li>
</ul>
<p>Il est clair que lu comme Ã§a, le plus intÃ©ressant est le <code>^</code> et câ€™est justement <a href="http://fredkschott.com/post/2014/02/npm-no-longer-defaults-to-tildes/">celui qui est choisi maintenant [en]</a> lorsque lâ€™on fait un <code>npm install --save</code>. Cool non ?!</p>
<p>Pour plus dâ€™information sur la dÃ©finition des versions, <a href="https://github.com/isaacs/node-semver#ranges">câ€™est par lÃ </a> (Oh mon dieu, il a fait un lien avec un â€œcliquez iciâ€).</p>
<p>Bon. Câ€™est bon ? Vous avez tout compris ? Okay, vous pouvez passer Ã  <a href="/posts/nodejs/napa-ou-comment-telecharger-package-napa-package-json/"><strong>napa</strong></a> maintenant qui vous aidera grandement sur le tÃ©lÃ©chargement de projets nâ€™ayant pas de <code>package.json</code>.</p>
<p>En ce qui concerne npm, je mâ€™arrÃªte lÃ , et vous propose une petite solution afin dâ€™augmenter la vitesse de vos installations de node modules.</p>
<h2 id="bonus">
      <a class="putainde-Title-anchor" href="#bonus">#</a>
      Bonus
    </h2><p>Envie dâ€™accÃ©lÃ©rer vos installations npm ? Je vous conseille <a href="https://github.com/vvo/npm-pkgr">npm-pkgr</a>.</p>
<p>Il hashera votre <code>package.json</code> pour savoir sâ€™il a Ã©tÃ© modifiÃ© ou non, et en fonction de Ã§a, il lancera <code>npm install</code> ou non. SacrÃ© gain de temps (surtout si vous faites des <code>npm install</code> Ã  chaque <em>deploy</em>).</p>
<p>You are now a npm master. ğŸ‘¨</p>
</div></div><footer class="putainde-Post-footer"><div class="putainde-Post-footer-title">Action sur cette page</div><div class="r-Grid"><div class="r-Grid-cell r-all--1of3"><a class="putainde-Post-footer-action" href="http://github.com/putaindecode/putaindecode.fr/edit/master/content/posts/nodejs/npm-choisir-version/index.md">Modifier</a></div><div class="r-Grid-cell r-all--1of3"><a class="putainde-Post-footer-action" href="http://github.com/putaindecode/putaindecode.fr/blame/master/content/posts/nodejs/npm-choisir-version/index.md">Tracer les changements</a></div><div class="r-Grid-cell r-all--1of3"><a class="putainde-Post-footer-action" href="http://github.com/putaindecode/putaindecode.fr/commits/master/content/posts/nodejs/npm-choisir-version/index.md">Historique</a></div></div><div><div class="putainde-Author undefined"><a href="http://kud.io" class="putainde-Avatar putainde-Author-picture"><img class="js-AnimateLoad" src="https://avatars.githubusercontent.com/u/655838?v=3&amp;s=128" alt=""></a><div class="putainde-Author-description"><div class="putainde-Author-title"><h3 class="putainde-Author-name"><span class="putainde-WrittenBy">Ã‰crit par </span><a class="putainde-Link" href="http://kud.io">kud</a></h3><div class="putainde-Author-social"><a href="http://kud.io" class="r-Tooltip r-Tooltip--top" data-r-tooltip="Website"><img class="putainde-Icon" src="/icons/home.svg"></a><a href="https://twitter.com/_kud" class="r-Tooltip r-Tooltip--top" data-r-tooltip="Twitter"><img class="putainde-Icon" src="/icons/twitter.svg"></a><a href="https://github.com/kud" class="r-Tooltip r-Tooltip--top" data-r-tooltip="Github"><img class="putainde-Icon" src="/icons/github.svg"></a></div></div><p class="putainde-Author-bio">Viking UI engineer (avec une pointe de node.js), batteur, s&#x27;essayant Ã  la photographie, aime le cinema.</p></div></div></div><div class="putainde-Contributors"><strong class="putainde-Contributors-label">3 contributeurs</strong><div class="putainde-Contributor r-Tooltip r-Tooltip--bottom r-Tooltip--allowNewLines" data-r-tooltip="kud
(3 commits)"><a href="http://kud.io" class="putainde-Avatar putainde-Contributor-avatar"><img class="js-AnimateLoad" src="https://avatars.githubusercontent.com/u/655838?v=3&amp;s=128" alt=""></a></div><div class="putainde-Contributor r-Tooltip r-Tooltip--bottom r-Tooltip--allowNewLines" data-r-tooltip="MoOx
(3 commits)"><a href="http://moox.io/" class="putainde-Avatar putainde-Contributor-avatar"><img class="js-AnimateLoad" src="https://avatars.githubusercontent.com/u/157534?v=3&amp;s=128" alt=""></a></div><div class="putainde-Contributor r-Tooltip r-Tooltip--bottom r-Tooltip--allowNewLines" data-r-tooltip="yannickcr
(1 commit)"><a href="https://yannick.cr" class="putainde-Avatar putainde-Contributor-avatar"><img class="js-AnimateLoad" src="https://avatars.githubusercontent.com/u/13209?v=3&amp;s=128" alt=""></a></div></div><div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></footer></div></article></div><div class="putainde-Footer"><div class="r-Grid"><div class="r-Grid-cell r-all--3of12"><p class="putainde-Footer-text">Â© 1970 - 2015 Putain de code !</p></div><div class="r-Grid-cell r-all--6of12"><ul class="putainde-Footer-list"><li><a href="/feed.xml">Flux RSS</a></li><li><a href="/projets">Projets</a></li><li><a href="https://github.com/putaindecode/forum/issues">Forum</a></li><li><a href="irc://irc.freenode.net/putaindecode">IRC</a></li><li><a href="https://github.com/putaindecode/" data-r-tooltip="GitHub" class="r-Tooltip r-Tooltip--top"><img class="putainde-Icon" src="/icons/github.svg"></a></li><li><a href="https://twitter.com/putaindecode/" data-r-tooltip="Twitter" class="r-Tooltip r-Tooltip--top"><img class="putainde-Icon" src="/icons/twitter.svg"></a></li></ul></div><div class="r-Grid-cell r-all--3of12"><p class="putainde-Footer-text putainde-Footer-text--small putainde-Footer-text--right">Made with â™¥ï¸</p></div></div></div><script>var _gaq=[["_setAccount","UA-43771806-1"],["_trackPageview"]];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src="//www.google-analytics.com/ga.js";s.parentNode.insertBefore(g,s)}(document,"script"));</script><script>var disqus_shortname = "putaindecode";
var disqus_identifier = "http://putaindecode.fr/posts/nodejs/npm-choisir-version/";
var disqus_url = "http://putaindecode.fr/posts/nodejs/npm-choisir-version/";
var disqus_script = "embed.js";

(function(d,s) {
  s = d.createElement('script');s.async=1;s.src = '//' + disqus_shortname + '.disqus.com/'+disqus_script;
  (d.getElementsByTagName('head')[0]).appendChild(s)
})(document)
    </script></body></html>
